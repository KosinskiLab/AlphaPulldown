# Tutorial: Predicting Protein Complex Structures with AlphaPulldown and AlphaLink

This tutorial guides you through the process of predicting protein complex structures using **AlphaPulldown** and **AlphaLink**, tools that extend AlphaFold's capabilities for multimeric protein complexes and incorporate experimental cross-linking data, respectively.

## Prerequisites

- Access to a Linux terminal with AlphaPulldown and AlphaLink installed.
- Basic familiarity with command-line operations.
- ChimeraX installed on your local machine for visualization.

---

## Overview

We will:

1. **Generate features** for individual protein chains using AlphaPulldown.
2. **Configure and run AlphaPulldown** to predict protein complexes.
3. **Prepare cross-linking data** and use AlphaLink for structure prediction.
4. **Run standard AlphaFold predictions** for comparison.
5. **Visualize and compare models** in ChimeraX.

---

## Step 1: Set Up the Working Environment

### Copy Tutorial Data to Your Home Directory

First, copy the tutorial data to your home directory:

```bash
cp -r /scratch/denbi/k8s/sunday_tutorial_copy/ ~/
cd ~/sunday_tutorial_copy/
```

---

## Step 2: Generate Features for Individual Chains

To predict protein complexes, we need to generate features for each individual protein chain.

### Proteins Used in This Tutorial

We will use three subunits of the **DNA-directed RNA polymerase III**:

- **P32349**: [UniProt Entry](https://www.uniprot.org/uniprotkb/P32349/entry)
- **P32910**: [UniProt Entry](https://www.uniprot.org/uniprotkb/P32910/entry)
- **P17890**: [UniProt Entry](https://www.uniprot.org/uniprotkb/P17890/entry)

### Create a FASTA File for P17890

1. **Copy the sequence** from the [UniProt entry for P17890](https://www.uniprot.org/uniprotkb/P17890/entry).

2. **Create a FASTA file** named `P17890.fasta` using a text editor (e.g., `gedit`, `nano`):

   ```bash
   nano P17890.fasta
   ```

3. **Paste the following content** into the file:

   ```text
   >P17890
   MSSYRGGSRGGGSNYMSNLPFGLGYGDVGKNHITEFPSIPLPINGPITNKERSLAVKYIN
   FGKTVKDGPFYTGSMSLIIDQQENSKSGKRKPNIILDEDDTNDGIERYSDKYLKKRKIGI
   SIDDHPYNLNLFPNELYNVMGINKKKLLAISKFNNADDVFTGTGLQDENIGLSMLAKLKE
   LAEDVDDASTGDGAAKGSKTGEGEDDDLADDDFEEDEDEEDDDDYNAEKYFNNGDDDDYG
   DEEDPNEEAAF
   ```

4. **Save and close** the file.

### Generate Features Using AlphaPulldown

Run the following command to generate features for P17890:

```bash
create_individual_features.py \
  --fasta_paths=P17890.fasta \
  --data_dir=/scratch/AlphaFold_DBs/2.3.2/ \
  --output_dir=features_mmseqs2/ \
  --max_template_date=2050-01-01 \
  --use_mmseqs2
```

**Explanation of arguments**:

- `--fasta_paths`: Path to the input FASTA file(s).
- `--data_dir`: Directory containing AlphaFold databases.
- `--output_dir`: Directory to store the generated features.
- `--max_template_date`: Cutoff date for template structures (set far in the future to include all templates).
- `--use_mmseqs2`: Use MMseqs2 for fast multiple sequence alignment.

**Note**: Since the sequence is short and we're using MMseqs2, this should complete in about **1 minute**.

### Verify the Generated Features

List the contents of the features directory:

```bash
ls features_mmseqs2/
```

You should see:

```bash
P17890.a3m
P17890_env
P17890_feature_metadata_<date>.json
P17890.pkl
```

---

## Step 3: Configure AlphaPulldown for Complex Prediction

We will now set up AlphaPulldown to predict interactions between the protein subunits.

### Create a Protein Pair List

Create a file named `custom.txt` containing the protein pairs to model:

```bash
nano custom.txt
```

Add the following lines:

```text
P32349+P32910
P32349+P17890
P32910+P17890
```

**Explanation**:

- Each line represents a protein pair to model, with protein IDs separated by a `+`.

---

## Step 4: Run AlphaPulldown

Run AlphaPulldown to predict the structures of the protein complexes:

```bash
run_multimer_jobs.py \
  --mode=custom \
  --num_predictions_per_model=1 \
  --model_names=model_2_multimer_v3 \
  --output_path=predictions/ \
  --data_dir=/scratch/AlphaFold_DBs/2.3.2/ \
  --protein_lists=custom.txt \
  --monomer_objects_dir=features_ap_tutorial/
```

**Explanation of arguments**:

- `--mode=custom`: Use a custom list of protein pairs.
- `--num_predictions_per_model=1`: Generate one prediction per model.
- `--model_names=model_2_multimer_v3`: Specify the AlphaFold multimer model version.
- `--output_path=predictions/`: Directory to store predictions.
- `--data_dir`: AlphaFold databases directory.
- `--protein_lists=custom.txt`: File containing protein pairs.
- `--monomer_objects_dir`: Directory with pre-calculated features for individual proteins.

**Note**: Each protein pair should take **1-2 minutes** to process.

### Verify the Predictions

List the contents of the predictions directory:

```bash
ls predictions/
```

You should see:

```bash
P32349_and_P17890
P32349_and_P32910
P32910_and_P17890
```

Check the contents of one of the prediction directories:

```bash
ls predictions/P32349_and_P17890/
```

Expected output:

```bash
confidence_model_2_multimer_v3_pred_0.json
pae_plot_ranked_0.png
ranked_0.pdb
ranking_debug.json
timings.json
pae_model_2_multimer_v3_pred_0.json
ranked_0.cif
ranked_0.zip
result_model_2_multimer_v3_pred_0.pkl
unrelaxed_model_2_multimer_v3_pred_0.pdb
```

---

## Step 5: Analyze the Results

### Check Model Scores

The `ranking_debug.json` file contains scores that help assess the quality of the models.

To extract the scores:

```bash
grep -A 1 'iptm+ptm' predictions/*/ranking_debug.json
```

**Explanation**:

- `grep -A 1 'iptm+ptm'`: Search for the line containing 'iptm+ptm' and display that line along with the following line (`-A 1`).
- This will show the interface predicted TM-score plus the predicted TM-score, which are indicators of model confidence.

### Visualize the Models in ChimeraX

To visualize the predicted complex:

1. **Download the model** `ranked_0.pdb` from `predictions/P32349_and_P17890/` to your local machine.

2. **Open ChimeraX**.

3. **Load the model**:

   ```bash
   open ranked_0.pdb
   ```

---

## Step 6: Running AlphaLink with Cross-Linking Data

We will now use **AlphaLink** to incorporate experimental cross-linking data into the protein complex prediction.

   ```

**Open the AlphaLink terminal**:

   - Click the **second blue ring** in the taskbar.

### Prepare Input Data for AlphaLink

1. **Copy the AlphaLink input data**:

   ```bash
   cp -r /scratch/denbi/k8s/dima/alphalink_input ~/
   cd ~/alphalink_input/
   ls
   ```

   You should see:

   ```bash
   A.fasta
   B.fasta
   features_mmseqs2/
   H1142.csv
   ```

2. **Examine the cross-linking data**:

   ```bash
   gedit H1142.csv &
   ```

   The `H1142.csv` file contains cross-linking data between proteins A and B.

### Generate Cross-Link File Compatible with AlphaLink

Convert the CSV file to a pickle file:

```bash
generate_crosslink_pickle.py --csv H1142.csv --output crosslinks.pkl.gz
```

**Explanation**:

- This script converts cross-linking data into a format that AlphaLink can use.

### Run AlphaLink Prediction

Run the structure prediction with AlphaLink:

```bash
run_structure_prediction.py \
  --input A+B \
  --output_directory predictions/ \
  --num_cycle 3 \
  --num_predictions_per_model 1 \
  --data_directory /scratch/AlphaFold_DBs/2.3.2/ \
  --alphalink_weights /scratch/AlphaFold_DBs/2.3.2/alphalink_weights/AlphaLink-Multimer_SDA_v3.pt \
  --features_directory features_mmseqs2/ \
  --pair_msa \
  --nomsa_depth_scan \
  --nomultimeric_template \
  --crosslinks crosslinks.pkl.gz \
  --fold_backend alphalink \
  --nocompress_result_pickles \
  --noremove_result_pickles \
  --use_ap_style \
  --use_gpu_relax \
  --protein_delimiter + \
  --models_to_relax None
```

**Alternative**:

- You can run the prediction using the provided script:

  ```bash
  ./predict.sh
  ```

### Convert Cross-Links to Pseudobonds for Visualization

Generate a pseudobonds file for ChimeraX:

```bash
python csv2pb.py H1142.csv H1142.pb
```

---

## Step 7: Visualize the AlphaLink Model in ChimeraX

### Download the Model and Pseudobonds File

Use the web interface at [https://bard-external.embl.de/](https://bard-external.embl.de/) to download:

- `predictions/A+B/ranked_0.pdb` (AlphaLink model)
- `H1142.pb` (pseudobonds file)

### Visualize in ChimeraX

1. **Open ChimeraX**.

2. **Load the AlphaLink model**:

   ```bash
   open ranked_0.pdb
   ```

3. **Load the pseudobonds file**:

   ```bash
   open H1142.pb
   ```

4. **Assess Cross-Link Satisfaction**:

   - The pseudobonds represent cross-links.
   - Check if the distances between linked residues satisfy the cross-linking constraints.

---

## Step 8: Running Standard AlphaFold for Comparison

We will now run a standard AlphaFold prediction without cross-linking data to compare with the AlphaLink model.

### Switch to AlphaFold Terminal

1. **Close the current terminal**.

2. **Open a new terminal** configured for AlphaFold:

   - Click the appropriate icon in the taskbar.

### Run AlphaFold Prediction

1. **Navigate to the input directory**:

   ```bash
   cd ~/alphalink_input/
   ```

2. **Run the prediction**:

   ```bash
   run_structure_prediction.py \
     --input A+B \
     --output_directory predictions_af/ \
     --features_directory features_mmseqs2/ \
     --data_directory /scratch/AlphaFold_DBs/2.3.2/
   ```

### Visualize the AlphaFold Model

1. **Download the AlphaFold model** from `predictions_af/A+B/ranked_0.pdb`.

2. **Open ChimeraX**.

3. **Load the AlphaFold model**:

   ```bash
   open ranked_0.pdb
   ```

4. **Load the pseudobonds file**:

   ```bash
   open H1142.pb
   ```

---

## Step 9: Compare AlphaLink and AlphaFold Models

### Load Both Models in ChimeraX

1. **Load the AlphaLink model** (if not already loaded):

   ```bash
   open alphalink_ranked_0.pdb
   ```

2. **Load the AlphaFold model**:

   ```bash
   open alphafold_ranked_0.pdb
   ```

### Superimpose the Models

Use the `matchmaker` command:

```bash
mm #1 #2
```

- `#1` and `#2` refer to the model IDs in ChimeraX.
- Adjust the IDs if necessary.

### Analyze Cross-Link Satisfaction

1. **Check cross-link distances**:

   - Use the `distance` command to measure distances between cross-linked residues.

     ```bash
     distance sel
     ```

2. **Visualize Violations**:

   - Color pseudobonds based on whether they satisfy the cross-linking constraints.

     ```bash
     color green H1142.pb length < 35
     color red H1142.pb length >= 35
     ```

   - Cross-links shorter than 35 Å are colored green (satisfied), others are red (violated).

### Assess the Impact of Cross-Linking Data

- **AlphaLink Model**:

  - Should show better satisfaction of cross-linking restraints.

- **AlphaFold Model**:

  - May have more violations due to the absence of cross-linking data.

---

## Step 10: Summary and Further Exploration

In this tutorial, we've:

- **Generated features** for individual protein chains.
- **Predicted protein complexes** using AlphaPulldown.
- **Incorporated cross-linking data** using AlphaLink.
- **Ran standard AlphaFold predictions** for comparison.
- **Visualized and compared models** in ChimeraX.

**Key Takeaways**:

- **AlphaPulldown** extends AlphaFold for predicting multimeric complexes.
- **AlphaLink** incorporates experimental cross-linking data to improve predictions.
- **Visualization in ChimeraX** helps assess model quality and cross-link satisfaction.

**Next Steps**:

- **Experiment with Different Proteins**:

  - Try other protein pairs or complexes.

- **Adjust Parameters**:

  - Explore the impact of different parameters on prediction quality.

- **Incorporate Additional Data**:

  - Use other types of experimental data to guide predictions.

---

## Additional Resources

- **AlphaFold GitHub Repository**: [https://github.com/deepmind/alphafold](https://github.com/deepmind/alphafold)
- **AlphaPulldown Documentation**: [Link to documentation]
- **AlphaLink Publication**: [Link to relevant publication]
- **ChimeraX Tutorials**: [https://www.rbvi.ucsf.edu/chimerax/tutorials/index.html](https://www.rbvi.ucsf.edu/chimerax/tutorials/index.html)

---

